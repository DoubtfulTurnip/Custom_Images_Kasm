ARG BASE_TAG="develop"
ARG BASE_IMAGE="core-ubuntu-focal"

FROM kasmweb/$BASE_IMAGE:$BASE_TAG

USER root


ENV HOME /home/kasm-default-profile
ENV STARTUPDIR /dockerstartup
WORKDIR $HOME



### Envrionment config
ENV DEBIAN_FRONTEND noninteractive
ENV KASM_RX_HOME $STARTUPDIR/kasmrx
ENV INST_SCRIPTS $STARTUPDIR/install


###
ARG CAST_VERSION=v0.14.0
RUN export DEBIAN_FRONTEND=noninteractive && \
    apt-get update && \
    apt-get install -y wget gnupg git curl sudo openssh-server && \
    curl -Lo cast_${CAST_VERSION}_linux_amd64.deb https://github.com/ekristen/cast/releases/download/${CAST_VERSION}/cast_${CAST_VERSION}_linux_amd64.deb && \
    dpkg -i cast_${CAST_VERSION}_linux_amd64.deb 
   
###
RUN cast install --mode=server teamdfir/sift-saltstack 
###

RUN apt-get autoremove -y && apt-get purge && apt-get clean && \
    rm -rf /srv && \
    rm -rf /var/cache/salt/* && \
    rm -rf /root/.cache/* && \


#Permissions
RUN $STARTUPDIR/set_user_permission.sh $HOME
RUN chown 1000:1000 $HOME
ENV HOME /home/kasm-user
WORKDIR $HOME
RUN mkdir -p $HOME && chown -R 1000:1000 $HOME

USER 1000

CMD ["--tail-log"]
